---
import Markdoc from "@markdoc/markdoc";
import type { Components } from "astro-markdoc-renderer";
import { MarkdocRenderer } from "astro-markdoc-renderer";
import { CollectionEntry, getCollection } from "astro:content";
import CodeBlock from "../../components/CodeBlock.astro";
import Layout from "../../layouts/base.astro";

export async function getStaticPaths() {
  const tils = await getCollection("til");
  return tils.map((til) => ({
    params: { slug: til.slug },
    props: { til },
  }));
}

const components = {
  CodeBlock: {
    Component: CodeBlock,
    props: {},
  },
} satisfies Components;

type Props = { til: CollectionEntry<"til"> };

const { til } = Astro.props;

const ast = Markdoc.parse(til.body);
const content = Markdoc.transform(ast, {
  nodes: {
    fence: {
      render: "CodeBlock",
      attributes: {
        content: { type: String, render: false, required: true },
        language: { type: String },
      },
      transform(node, config) {
        const attributes = node.transformAttributes(config);
        const children = node.transformChildren(config);
        return new Markdoc.Tag(
          this.render,
          { ...attributes, content: children.join("") },
          []
        );
      },
    },
  },
});
---

<Layout title={til.data.title}>
  <a href="/til" class="font-bold block mb-8"
    ><i class="fa-solid fa-arrow-left mr-2"></i>Back to TILs</a
  >
  <section class="mb-8 prose">
    <div class="mb-8">
      <h1 class="text-4xl font-bold mb-2">{til.data.title}</h1>
      <time class="text-gray-500"
        >{
          til.data.date.toLocaleDateString("en-us", {
            year: "numeric",
            month: "long",
            day: "numeric",
          })
        }</time
      >
    </div>
    <MarkdocRenderer content={content} components={components} />
  </section>
</Layout>
